<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard — Live</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f6f7fb;color:#222;margin:20px}
    .container{max-width:1100px;margin:0 auto}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .controls{display:flex;gap:8px;align-items:center}
    .card-row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
    .card{background:#fff;padding:14px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.06);flex:1;min-width:200px}
    .label{font-size:12px;color:#666}
    .value{font-size:24px;font-weight:600;color:#0b63d6}
    #logs{background:#fff;padding:12px;border-radius:8px;max-height:280px;overflow:auto}
    .status{font-size:13px;color:#444}
    button, input[type=number]{padding:6px 10px;border-radius:6px;border:1px solid #ddd;background:#fff}
    .small{font-size:12px;color:#666}
    footer{margin-top:14px;font-size:13px;color:#555}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Admin Dashboard (Live)</h1>
      <div class="controls">
        <button id="btn-refresh">Refresh</button>
        <label class="small">Interval:
          <select id="interval" style="padding:6px;border-radius:6px;border:1px solid #ddd;background:#fff">
            <option value="5">5s</option>
            <option value="30">30s</option>
            <option value="60">1m</option>
          </select>
        </label>
        <button id="btn-toggle">Pause</button>
      </div>
    </header>

    <section class="card-row">
      <div class="card">
        <div class="label">Total Users</div>
        <div class="value" id="totalUsers">—</div>
      </div>
      <div class="card">
        <div class="label">Total Listings</div>
        <div class="value" id="totalListings">—</div>
      </div>
      <div class="card">
        <div class="label">Total Transactions</div>
        <div class="value" id="totalTransactions">—</div>
      </div>
    </section>

    <section class="card-row">
      <div class="card">
        <div class="label">Completed</div>
        <div class="value" id="transactionsCompleted">—</div>
      </div>
      <div class="card">
        <div class="label">Cancelled</div>
        <div class="value" id="transactionsCancelled">—</div>
      </div>
      <div class="card">
        <div class="label">Pending</div>
        <div class="value" id="transactionsPending">—</div>
      </div>
    </section>

    <div id="logs">
      <div class="small" id="status">Connecting to live stream...</div>
      <div id="activity"></div>
    </div>

    <footer>
      <span id="clientCount">Connected clients: —</span>
      <span style="float:right" id="lastUpdated">Last updated: —</span>
    </footer>
  </div>

  <script>
    // Endpoints used by this page
    const streamUrl = '/api/admin/dashboard/stream';
    const summaryUrl = '/api/admin/dashboard/summary';
    const clientsUrl = '/api/admin/dashboard/clients';
    const refreshUrl = '/api/admin/dashboard/refresh';
    const intervalUrl = '/api/admin/dashboard/refresh/interval';
    const toggleUrl = '/api/admin/dashboard/refresh/toggle';

    let isPaused = false;
    let lastData = null;

    function log(type, text){
      const el = document.createElement('div');
      el.textContent = new Date().toLocaleTimeString() + ' ['+type+'] ' + text;
      const activity = document.getElementById('activity');
      activity.insertBefore(el, activity.firstChild);
      if(activity.children.length > 200) activity.removeChild(activity.lastChild);
    }

    function setLastUpdated(ts){
      const el = document.getElementById('lastUpdated');
      const d = ts ? new Date(ts) : new Date();
      el.textContent = 'Last updated: ' + d.toLocaleString();
    }

    function render(data){
      if(!data) return;
      const map = {
        totalUsers: 'totalUsers',
        totalListings: 'totalListings',
        totalTransactions: 'totalTransactions',
        transactionsCompleted: 'transactionsCompleted',
        transactionsCancelled: 'transactionsCancelled',
        transactionsPending: 'transactionsPending'
      };
      Object.keys(map).forEach(k => {
        const el = document.getElementById(k);
        if(!el) return;
        const v = data[k] !== undefined ? data[k] : (data[map[k]] !== undefined ? data[map[k]] : null);
        el.textContent = (v !== null) ? new Intl.NumberFormat().format(v) : '—';
      });

      // If server provides a timestamp (preferred), use it
      if(data.timestamp) setLastUpdated(data.timestamp);
      else if(data.lastUpdated) setLastUpdated(data.lastUpdated);
      else setLastUpdated();
    }

    // Create SSE and handle events robustly
    let es;
    function connectSse(){
      if(es) try{ es.close(); }catch(e){}
      es = new EventSource(streamUrl);

      es.addEventListener('dashboard', e => {
        try{
          const payload = JSON.parse(e.data);
          if(!lastData) log('INIT','Initial dashboard data received');
          else log('UPDATE','Dashboard updated');
          lastData = payload;
          render(payload);
        }catch(err){
          console.error('Invalid SSE data', err);
          log('ERROR','Invalid SSE payload');
        }
        document.getElementById('status').textContent = 'Live: connected';
      });

      es.onopen = () => document.getElementById('status').textContent = 'Live: connection opened';
      es.onerror = () => {
        document.getElementById('status').textContent = 'Live: connection lost, retrying...';
        log('ERROR','SSE connection error — will retry automatically');
      };
    }

    connectSse();

    // Refresh button: request server to broadcast and then fetch snapshot immediately
    document.getElementById('btn-refresh').addEventListener('click', async () => {
      try {
        await fetch(refreshUrl, { method: 'POST' });
        log('REFRESH','Refresh requested (server broadcast)');
      } catch (err) {
        log('ERROR','Refresh request failed');
      }
      // Immediately update UI from summary so user sees instant result
      try {
        const r = await fetch(summaryUrl);
        if (r.ok) {
          const data = await r.json();
          render(data);
          log('REFRESH','UI updated from summary snapshot');
        }
      } catch (err) {
        // ignore; SSE will update when available
      }
    });

    // Interval control
    document.getElementById('interval').addEventListener('change', (e) => {
      const s = Number(e.target.value) || 5;
      fetch(intervalUrl + '?seconds=' + s, { method: 'POST' })
        .then(() => log('INFO','Refresh interval set to ' + s + 's'))
        .catch(() => log('ERROR','Failed to set interval'));
    });

    // Toggle pause/resume
    document.getElementById('btn-toggle').addEventListener('click', () => {
      isPaused = !isPaused;
      // The backend expects enabled=true to allow automatic refresh
      fetch(toggleUrl + '?enabled=' + (!isPaused), { method: 'POST' })
        .then(() => {
          document.getElementById('btn-toggle').textContent = isPaused ? 'Resume' : 'Pause';
          log('INFO', (isPaused ? 'Paused' : 'Resumed') + ' automatic refresh');
        })
        .catch(() => log('ERROR','Failed to toggle refresh'));
    });

    // Periodically refresh client count
    async function refreshClients(){
      try{
        const r = await fetch(clientsUrl);
        if(!r.ok) return;
        const n = await r.json();
        document.getElementById('clientCount').textContent = 'Connected clients: ' + n;
      }catch(e){ /* ignore */ }
    }
    setInterval(refreshClients, 5000);
    refreshClients();

    // Fallback: load a snapshot on start (summary) if SSE misses initial
    (async ()=>{
      try{
        const r = await fetch(summaryUrl);
        if(r.ok){
          const data = await r.json();
          if(!lastData){ render(data); log('SNAP','Loaded snapshot from summary'); }
        }
      }catch(e){}
    })();
  </script>
</body>
</html>